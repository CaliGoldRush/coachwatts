description = "Merges a GitHub Pull Request locally or remotely, ensuring non-interactive execution and inline commit messages."
prompt = """
Your goal is to help the user merge a GitHub Pull Request (PR) into their current local branch or the remote repository.

User input: {{args}}

# Workflow

0.  **Ensure Clean State (CRITICAL):**
    - Run `git status --porcelain` to check for uncommitted changes.
    - If there are local changes, **STOP** and ask the user if they want to commit them *before* proceeding with the merge.
    - If the user agrees, run `git add . && git commit -m "chore: save local changes before merging PR"` (or ask for a specific message).
    - **DO NOT** attempt to merge if the working directory is not clean, as this can lead to data loss or conflict complexities.

1.  **Identify the Pull Request:**
    - Parse `{{args}}` to find a PR number or URL.
    - If no PR is specified, list open PRs using `search_pull_requests` (filtered by `state:open`) or `gh pr list --json number,title,author -L 10` to help the user choose.

2.  **Analyze Context, Comments & Linked Issues (CRITICAL):**
    - **Fetch PR Details:** Use `pull_request_read` (method='get') to get the PR details (branch name, author, description).
    - **Identify Linked Issues:** Parse the PR description and comments for issue references (e.g., `#123`, `fixes #123`). If none are found, use `github__search_issues` with keywords from the PR title to find potentially related issues.
    - **Read Comments:** Use `gh pr view <pr_number> --comments` or `pull_request_read` (method='get_comments').
    - **Analyze:** Specifically look for "suggestions", "requirements", or "feedback" that might block the merge.
    - **Report:** Briefly summarize the PR, list any identified issues, and report any crucial feedback found in the comments *before* merging. Confirm with the user if the identified issues should be linked/closed.

3.  **Fetch and Merge (Non-Interactive):**
    - **Local Merge (Preferred for Testing):**
        - Fetch the PR branch: `git fetch origin pull/<pr_number>/head:pr-<pr_number>`.
        - Merge the branch using the `--no-edit` flag and a message that references the linked issues (e.g., `Merge PR #86; Closes #120`): 
          `git merge pr-<pr_number> -m "Merge pull request #<pr_number> from <head_ref>. Closes <linked_issues>" --no-edit`.
    - **Remote Merge (GitHub CLI):**
        - If the user wants to merge directly on GitHub:
          `gh pr merge <pr_number> --merge --subject "Merge pull request #<pr_number>" --body "Merged via Gemini CLI. Closes <linked_issues>"` 
          (Always specify `--merge`, `--squash`, or `--rebase` and a subject to ensure non-interactive execution).
    - **Handle Conflicts:** If `git merge` reports conflicts, stop immediately. Do not attempt to resolve them automatically unless specifically directed.

4.  **Post-Merge Verification & Issue Closing:**
    - Run `git status` and `git log -n 1` to confirm the successful merge.
    - **Close Linked Issues:** For any identified issues that aren't automatically closed by GitHub (e.g., if keywords were missing), use `issue_write` (method='update', state='closed') to close them manually after the merge is confirmed.
    - Inform the user of the merge result and which issues were closed.

5.  **Completion:**
    - Ask the user if they want to:
        - Run verification scripts (lint/test).
        - Push the local changes if merged locally (`git push`).
        - Delete the temporary local PR branch (`git branch -D pr-<pr_number>`).
"""
